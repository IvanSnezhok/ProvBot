# ProvBot - Telegram Bot для Провайдера

Telegram бот для провайдера, написаний на Go, з підтримкою мультимовності, інтеграцією з білінговою системою, адмін панеллю та системою чату підтримки.

## Функціонал

### Для користувачів:

- **Реєстрація та управління профілем**

  - Реєстрація через номер телефону
  - Зв'язування з обліковим записом у білінговій системі
  - Перегляд профілю з інформацією про баланс
- **Поповнення балансу**

  - Поповнення через Telegram Payments
  - Тимчасовий платіж (24 години доступу)
  - Створення інвойсів для різних сум
- **Перегляд послуг**

  - Список активних послуг
  - Статуси послуг
- **Чат з техпідтримкою**

  - Двостороння комунікація з адміністраторами
  - Звернення через бота
- **Мультимовність**

  - Підтримка української, англійської та російської мов
  - Зміна мови в будь-який момент
- **Автоматичні сповіщення**

  - Сповіщення про низький баланс (через scheduler)

### Для адміністраторів:

- **Адмін панель** (`/admin`)

  - Статистика бота (`/stats`)
  - Швидкий доступ до всіх функцій
- **Управління користувачами** (`/users`)

  - Пошук користувачів за:
    - Номером договору
    - Номером телефону
    - Ім'ям
    - Адресою
  - Перегляд інформації про користувача
  - Меню облікового запису
- **Управління балансом**

  - Зміна балансу користувача
  - Створення тимчасових платежів
  - Перегляд історії платежів
- **Розсилка повідомлень** (`/broadcast`)

  - Розсилка тексту, фото, документів, відео
  - Масові сповіщення користувачів
- **Чат підтримки**

  - Підключення до чату з користувачем (`/connect <user_id>`)
  - Завершення чату (`/end_chat`)
  - Перегляд історії повідомлень (`/logs`)
- **Логи та моніторинг**

  - Перегляд історії повідомлень користувачів
  - Логування всіх операцій

## Вимоги

- **Go 1.25.3** або вище
- **PostgreSQL 12+** (для даних бота)
- **MySQL 5.7+** (для білінгової системи, опціонально)
- **Telegram Bot Token**
- **Telegram Payments Provider Token** (для платежів)

## Встановлення

1. Клонуйте репозиторій:

```bash
git clone <repository-url>
cd ProvBot
```

2. Встановіть залежності:

```bash
go mod download
```

3. Створіть файл `.env` та налаштуйте змінні середовища:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_here
PROVIDER_TOKEN=your_provider_token_here

# PostgreSQL (обов'язково)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=provbot
POSTGRES_PASSWORD=your_password
POSTGRES_DB=provbot_db
POSTGRES_SSLMODE=disable

# MySQL (опціонально, для білінгової системи)
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=billing_user
MYSQL_PASSWORD=your_password
MYSQL_DB=billing_db

# Адміністратори (через кому)
ADMIN_TELEGRAM_IDS=123456789,987654321

# Логування
LOG_LEVEL=info  # debug, info, warn, error

# Scheduler (опціонально)
SCHEDULER_WORKERS=10  # Кількість воркерів для паралельної обробки

# Webhook (опціонально)
BOT_WEBHOOK_URL=https://yourdomain.com/webhook
BOT_WEBHOOK_PORT=8443

# Оточення
APP_ENV=production  # development, production
```

4. Створіть базу даних PostgreSQL та виконайте міграції:

```bash
# Створіть базу даних
createdb provbot_db

# Виконайте міграції
psql -d provbot_db -f internal/database/migrations/001_init_schema.up.sql
```

5. Запустіть бота:

```bash
go run cmd/bot/main.go
```

Або збірка:

```bash
go build -o provbot cmd/bot/main.go
./provbot
```

## Структура проекту

```
ProvBot/
├── cmd/bot/              # Точка входу додатку
│   └── main.go          # Ініціалізація та запуск бота
├── internal/
│   ├── bot/             # Основний обробник бота
│   │   ├── handler.go   # Обробка оновлень
│   │   ├── context.go   # Контекст обробки
│   │   ├── middleware.go # Middleware для логування та реєстрації
│   │   └── handler_logger.go
│   ├── handlers/        # Обробники команд та подій
│   │   ├── admin/       # Адмінські обробники
│   │   │   ├── panel.go      # Адмін панель
│   │   │   ├── users.go      # Управління користувачами
│   │   │   ├── billing.go    # Управління балансом
│   │   │   ├── broadcast.go  # Розсилка повідомлень
│   │   │   ├── account.go    # Меню облікового запису
│   │   │   ├── logs.go       # Історія повідомлень
│   │   │   └── callbacks.go  # Callback queries
│   │   ├── user/        # Користувацькі обробники
│   │   │   ├── start.go      # Реєстрація та головне меню
│   │   │   ├── pay_bill.go   # Поповнення балансу
│   │   │   └── time_pay.go   # Тимчасовий платіж
│   │   ├── support/     # Чат підтримки
│   │   │   └── chat.go
│   │   └── context.go   # Спільний контекст
│   ├── models/          # Моделі даних
│   │   ├── user.go
│   │   ├── billing.go
│   │   ├── message_log.go
│   │   ├── bot_log.go
│   │   └── outage.go
│   ├── database/        # Підключення до БД та міграції
│   │   ├── postgres.go
│   │   ├── mysql.go
│   │   └── migrations/
│   ├── repository/      # Репозиторії для роботи з БД
│   │   ├── user_repo.go
│   │   ├── billing_repo.go
│   │   ├── log_repo.go
│   │   └── outage_repo.go
│   ├── service/         # Бізнес-логіка
│   │   ├── user_service.go
│   │   ├── billing_service.go
│   │   ├── admin_service.go
│   │   ├── support_service.go
│   │   └── notification_service.go
│   ├── scheduler/       # Планувальник завдань
│   │   └── notify_balance.go  # Сповіщення про баланс
│   ├── state/           # Управління станами користувачів
│   │   ├── manager.go
│   │   └── states.go
│   ├── i18n/           # Інтернаціоналізація
│   │   ├── translations.go
│   │   ├── ua.go       # Українська мова
│   │   └── en.go       # Англійська мова
│   └── utils/          # Утиліти
│       ├── config.go        # Завантаження конфігурації
│       ├── logger.go        # Логування в консоль
│       └── file_logger.go   # Логування в файли з ротацією
├── configs/            # Конфігураційні файли
├── log/                # Директорія для логів (створюється автоматично)
└── README.md
```

## Команди бота

### Користувацькі команди:

- `/start` - Почати роботу з ботом (реєстрація або головне меню)
- `/help` - Список доступних команд
- `/profile` - Переглянути профіль та баланс
- `/balance` - Перевірити баланс та поповнити
- `/services` - Переглянути послуги та їх статуси
- `/support` - Звернутися до техпідтримки
- `/language` - Змінити мову інтерфейсу

### Адмін команди:

- `/admin` - Відкрити адмін панель
- `/stats` - Статистика бота
- `/users` - Управління користувачами
- `/broadcast` - Розсилка повідомлень
- `/connect <user_id>` - Підключитися до чату з користувачем
- `/end_chat` - Завершити поточний чат підтримки
- `/logs` - Переглянути історію повідомлень

## Конфігурація

### База даних

Бот використовує дві бази даних:

- **PostgreSQL** (обов'язково) - для зберігання даних бота:

  - Користувачі та їх налаштування
  - Логи повідомлень та подій
  - Аварії та події
  - Адміністратори
- **MySQL** (опціонально) - для інтеграції з білінговою системою:

  - Якщо MySQL недоступний, бот продовжить роботу без функцій білінгу
  - Використовується для пошуку користувачів та управління балансом

### Адміністратори

Додайте Telegram ID адміністраторів у змінну `ADMIN_TELEGRAM_IDS` через кому:

```env
ADMIN_TELEGRAM_IDS=123456789,987654321
```

### Логування

Бот підтримує структуроване логування:

- **Консоль** - JSON формат для інтеграції з системами моніторингу
- **Файли** - Ротація логів:
  - Максимальний розмір файлу: 100 MB
  - Зберігання: 4 резервні копії
  - Термін зберігання: 28 днів
  - Автоматичне стиснення старих логів

Рівні логування: `debug`, `info`, `warn`, `error`

### Scheduler

Автоматичні сповіщення про баланс виконуються через scheduler з підтримкою паралельної обробки:

- Кількість воркерів налаштовується через `SCHEDULER_WORKERS` (за замовчуванням: 10)
- Автоматична перевірка балансу користувачів
- Відправка сповіщень про низький баланс

## Розробка

### Додавання нових команд

1. Створіть обробник у відповідній директорії (`internal/handlers/user/` або `internal/handlers/admin/`)
2. Додайте реєстрацію в `internal/bot/handler.go`:

```go
h.handlers["/newcommand"] = h.handleNewCommand
```

3. Реалізуйте функцію обробника:

```go
func (h *BotHandler) handleNewCommand(ctx *BotContext) error {
    // Логіка обробки
    return nil
}
```

### Додавання перекладів

Додайте нові ключі перекладів у файли:

- `internal/i18n/ua.go` - українська мова
- `internal/i18n/en.go` - англійська мова

Використовуйте функцію `Get()` або `Getf()` для отримання перекладів:

```go
text := ctx.Translator.Get("key")
text := ctx.Translator.Getf("key_with_format", arg1, arg2)
```

### Структура обробників

Обробники організовані за модулями:

- **User handlers** - для звичайних користувачів
- **Admin handlers** - для адміністраторів
- **Support handlers** - для чату підтримки

Кожен обробник отримує `HandlerContext` з усією необхідною інформацією.

## Особливості реалізації

### Telegram Payments

- Інтеграція з Telegram Payments API
- Створення інвойсів для різних сум
- Обробка pre-checkout та successful payment webhooks
- Валідація платежів перед підтвердженням

### Пошук в білінгу

- Інтеграція з MySQL білінговою системою
- Пошук по різним параметрам:
  - Номер договору
  - Номер телефону
  - Ім'я користувача
  - Адреса
- Форматування виводу інформації про користувача

### Чат підтримки

- Зберігання активних чатів (in-memory через StateManager)
- Двостороння комунікація між користувачем та адміном
- Автоматичне підключення адмінів до нових звернень
- Логування всіх повідомлень

### State Management

- Управління станами користувачів для багатокрокових операцій
- Автоматичне очищення застарілих станів
- Підтримка різних станів (очікування вводу суми, договору, підтримка тощо)

### Middleware

- **UserRegistrationMiddleware** - автоматична реєстрація користувачів
- **MessageLoggingMiddleware** - логування всіх повідомлень в БД
- **HandlerLoggingMiddleware** - логування виконання обробників

## Міграції БД

Міграції знаходяться в `internal/database/migrations/`.

Для виконання міграцій використовуйте інструмент `migrate` або виконуйте SQL файли вручну:

```bash
# Вгору
psql -d provbot_db -f internal/database/migrations/001_init_schema.up.sql

# Вниз (відкат)
psql -d provbot_db -f internal/database/migrations/001_init_schema.down.sql
```
